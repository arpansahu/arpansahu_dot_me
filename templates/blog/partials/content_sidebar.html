{% comment %}
Blog Content Sidebar - Shows categories and posts in sequence order.
Context variables:
  - sidebar_categories: QuerySet of Category objects with .ordered_posts
  - post (optional): Current blog post being viewed (for highlighting)
{% endcomment %}

{% if sidebar_categories %}
<div class="sidebar-widget content-sidebar-widget">
    <h3 class="sidebar-widget-title">
        <i class="fas fa-layer-group" style="color: #bb86fc; margin-right: 8px;"></i>
        Blog Series
    </h3>
    <div class="content-sidebar-body">
        {% for cat in sidebar_categories %}
        <div class="sidebar-category-group{% if cat.ordered_posts|length > 0 %} has-posts{% endif %}">
            <button class="sidebar-category-header{% if post and post.category_id == cat.id %} active{% endif %}" 
                    onclick="toggleCategoryGroup(this)" 
                    aria-expanded="{% if post and post.category_id == cat.id %}true{% else %}false{% endif %}">
                <span class="sidebar-category-name">
                    <i class="fas fa-folder{% if post and post.category_id == cat.id %}-open{% endif %} sidebar-folder-icon"></i>
                    {{ cat.name }}
                </span>
                <span class="sidebar-category-meta">
                    <span class="sidebar-post-count">{{ cat.ordered_posts|length }}</span>
                    <i class="fas fa-chevron-down sidebar-chevron"></i>
                </span>
            </button>
            <div class="sidebar-posts-list{% if post and post.category_id == cat.id %} expanded{% endif %}">
                {% for p in cat.ordered_posts %}
                <a href="{% url 'blog:blog_detail' p.slug %}" 
                   class="sidebar-post-link{% if post and post.id == p.id %} current{% endif %}"
                   {% if post and post.id == p.id %}aria-current="page"{% endif %}>
                    <span class="sidebar-post-number">{{ forloop.counter }}</span>
                    <span class="sidebar-post-title">{{ p.title }}</span>
                    {% if post and post.id == p.id %}
                    <i class="fas fa-bookmark sidebar-current-indicator"></i>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% if prev_post or next_post %}
<div class="sidebar-widget post-navigation-widget">
    <h3 class="sidebar-widget-title">
        <i class="fas fa-arrow-right-arrow-left" style="color: #bb86fc; margin-right: 8px;"></i>
        Navigate Series
    </h3>
    {% if prev_post %}
    <a href="{% url 'blog:blog_detail' prev_post.slug %}" class="post-nav-link prev-link">
        <span class="post-nav-direction"><i class="fas fa-arrow-left"></i> Previous</span>
        <span class="post-nav-title">{{ prev_post.title }}</span>
    </a>
    {% endif %}
    {% if next_post %}
    <a href="{% url 'blog:blog_detail' next_post.slug %}" class="post-nav-link next-link">
        <span class="post-nav-direction">Next <i class="fas fa-arrow-right"></i></span>
        <span class="post-nav-title">{{ next_post.title }}</span>
    </a>
    {% endif %}
</div>
{% endif %}
{% endif %}

<style>
/* Content Sidebar Styles */
.content-sidebar-widget {
    max-height: 70vh;
    display: flex;
    flex-direction: column;
}

.content-sidebar-body {
    overflow-y: auto;
    flex: 1;
    scrollbar-width: thin;
    scrollbar-color: rgba(187, 134, 252, 0.3) transparent;
}

.content-sidebar-body::-webkit-scrollbar {
    width: 5px;
}

.content-sidebar-body::-webkit-scrollbar-track {
    background: transparent;
}

.content-sidebar-body::-webkit-scrollbar-thumb {
    background: rgba(187, 134, 252, 0.3);
    border-radius: 10px;
}

.sidebar-category-group {
    margin-bottom: 4px;
}

.sidebar-category-header {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    border-radius: 8px;
    border: none;
    background: rgba(255, 255, 255, 0.03);
    color: rgba(255, 255, 255, 0.85);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.92rem;
    font-weight: 600;
    text-align: left;
    gap: 8px;
}

.sidebar-category-header:hover {
    background: rgba(187, 134, 252, 0.1);
    color: #fff;
}

.sidebar-category-header.active {
    background: rgba(187, 134, 252, 0.12);
    color: #bb86fc;
}

.sidebar-category-name {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.sidebar-folder-icon {
    font-size: 0.85rem;
    color: #bb86fc;
    flex-shrink: 0;
}

.sidebar-category-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.sidebar-post-count {
    background: rgba(187, 134, 252, 0.2);
    color: #bb86fc;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 700;
    min-width: 22px;
    text-align: center;
}

.sidebar-chevron {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.4);
    transition: transform 0.3s ease;
}

.sidebar-category-header[aria-expanded="true"] .sidebar-chevron {
    transform: rotate(180deg);
}

/* Posts list - collapsible */
.sidebar-posts-list {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    margin-left: 8px;
    border-left: 2px solid rgba(187, 134, 252, 0.15);
}

.sidebar-posts-list.expanded {
    max-height: 2000px;
}

.sidebar-post-link {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 12px 8px 16px;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.65);
    font-size: 0.88rem;
    line-height: 1.4;
    transition: all 0.2s ease;
    border-radius: 0 6px 6px 0;
    position: relative;
}

.sidebar-post-link:hover {
    background: rgba(255, 255, 255, 0.04);
    color: rgba(255, 255, 255, 0.9);
}

.sidebar-post-link.current {
    background: rgba(187, 134, 252, 0.1);
    color: #bb86fc;
    border-left: 2px solid #bb86fc;
    margin-left: -2px;
    font-weight: 600;
}

.sidebar-post-number {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.06);
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.72rem;
    font-weight: 700;
    margin-top: 1px;
}

.sidebar-post-link.current .sidebar-post-number {
    background: rgba(187, 134, 252, 0.2);
    color: #bb86fc;
}

.sidebar-post-title {
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.sidebar-current-indicator {
    color: #bb86fc;
    font-size: 0.75rem;
    flex-shrink: 0;
    margin-top: 3px;
}

/* Post Navigation Widget */
.post-navigation-widget {
    padding: 20px !important;
}

.post-nav-link {
    display: block;
    padding: 12px 15px;
    border-radius: 8px;
    text-decoration: none;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.06);
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.post-nav-link:last-child {
    margin-bottom: 0;
}

.post-nav-link:hover {
    background: rgba(187, 134, 252, 0.1);
    border-color: rgba(187, 134, 252, 0.2);
    transform: translateX(3px);
}

.post-nav-direction {
    display: block;
    font-size: 0.78rem;
    font-weight: 700;
    color: #bb86fc;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.post-nav-title {
    display: block;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.88rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.next-link .post-nav-direction {
    text-align: right;
}

.next-link:hover {
    transform: translateX(-3px);
}
</style>

<script>
function toggleCategoryGroup(btn) {
    const postsList = btn.nextElementSibling;
    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
    
    btn.setAttribute('aria-expanded', !isExpanded);
    postsList.classList.toggle('expanded');
    
    // Toggle folder icon
    const folderIcon = btn.querySelector('.sidebar-folder-icon');
    if (folderIcon) {
        if (!isExpanded) {
            folderIcon.classList.remove('fa-folder');
            folderIcon.classList.add('fa-folder-open');
        } else {
            folderIcon.classList.remove('fa-folder-open');
            folderIcon.classList.add('fa-folder');
        }
    }
}

// Auto-scroll to current post in sidebar if visible
document.addEventListener('DOMContentLoaded', function() {
    const currentLink = document.querySelector('.sidebar-post-link.current');
    if (currentLink) {
        setTimeout(() => {
            currentLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }, 300);
    }
});
</script>
